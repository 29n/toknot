<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="generator" content="PHPDoctor 2RC4 (http://peej.github.com/phpdoctor/)">
<meta name="when" content="Wed, 29 Aug 2012 07:49:30 +0000">

<link rel="stylesheet" type="text/css" href="../stylesheet.css">
<link rel="start" href="../overview-summary.html">

<title>XInotifySync.php (ToKnot Documentation)</title>

</head>
<body id="file" onload="parent.document.title=document.title;">

<div class="header">
<h1>ToKnot</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../todo-list.html">Todo</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source/xinotifysync.php.html" target="_top">No frames</a>
</div>
<hr>

<h1>XInotifySync.php</h1>
<div class="comment" id="overview_description"><p>Toknot</p><p>XInotifySync</p><p>PHP version 5.3</p></div>

<hr>

<a name="line1"></a><pre><?php
<a name="line2"></a>
<a name="line3"></a>/**
<a name="line4"></a> * Toknot
<a name="line5"></a> *
<a name="line6"></a> * XInotifySync
<a name="line7"></a> *
<a name="line8"></a> * PHP version 5.3
<a name="line9"></a> * 
<a name="line10"></a> * @author chopins xiao <chopins.xiao@gmail.com>
<a name="line11"></a> * @copyright  2012 The Authors
<a name="line12"></a> * @license    http://opensource.org/licenses/bsd-license.php New BSD License
<a name="line13"></a> * @link       http://blog.toknot.com
<a name="line14"></a> * @since      File available since Release $id$
<a name="line15"></a> */
<a name="line16"></a>
<a name="line17"></a>exists_frame();
<a name="line18"></a>
<a name="line19"></a>/**
<a name="line20"></a> * XInotifySync 
<a name="line21"></a> * 
<a name="line22"></a> * @version $id$
<a name="line23"></a> * @author Chopins xiao <chopins.xiao@gmail.com> 
<a name="line24"></a> */
<a name="line25"></a>final class XInotifySync {
<a name="line26"></a>    /**
<a name="line27"></a>     * inotify_instance 
<a name="line28"></a>     * 
<a name="line29"></a>     * @var mixed
<a name="line30"></a>     * @access private
<a name="line31"></a>     */
<a name="line32"></a>    private $inotify_instance = null;
<a name="line33"></a>    private $watch_descriptor = array();
<a name="line34"></a>    private $pending_event = 0;
<a name="line35"></a>    private $watch_list_conf_wd = null;
<a name="line36"></a>
<a name="line37"></a>    /**
<a name="line38"></a>     * max_sync_process_num 
<a name="line39"></a>     * max send file process
<a name="line40"></a>     * 
<a name="line41"></a>     * @var float
<a name="line42"></a>     * @access public
<a name="line43"></a>     */
<a name="line44"></a>    public $max_sync_process_num = 5;
<a name="line45"></a>    public $max_transporter = 5;
<a name="line46"></a>    private $log_file_dir = null;
<a name="line47"></a>    private $ssh_ins = null;
<a name="line48"></a>    private $run_dir = '/tmp';
<a name="line49"></a>    private $watch_list_conf = null;
<a name="line50"></a>
<a name="line51"></a>    public function __construct($watch_list_conf) {
<a name="line52"></a>        dl_extension('inotify','inotify_init');
<a name="line53"></a>        dl_extension('proctitle','setproctitle');
<a name="line54"></a>        dl_extension('posix','posix_getpid');
<a name="line55"></a>
<a name="line56"></a>        $cfg = XConfig::CFG();
<a name="line57"></a>        $cfg = $cfg->app;
<a name="line58"></a>        $this->log_file_dir = __X_APP_DATA_DIR__."/{$cfg->log_dir}/sync";
<a name="line59"></a>        xmkdir($this->log_file_dir);
<a name="line60"></a>        $this->run_dir = __X_APP_DATA_DIR__."/{$cfg->run_dir}/sync";
<a name="line61"></a>        xmkdir($this->run_dir);
<a name="line62"></a>        $watch_list_conf = __X_APP_DATA_DIR__."/conf/{$watch_list_conf}";
<a name="line63"></a>        if(!file_exists($watch_list_conf)) {
<a name="line64"></a>            throw new XException("Watch config file ({$watch_list_conf}) not exists");
<a name="line65"></a>        }
<a name="line66"></a>        $ips = stream_socket_pair(STREAM_PF_UNIX, STREAM_SOCK_STREAM,STREAM_IPPROTO_IP);
<a name="line67"></a>        //fork inotify process
<a name="line68"></a>        setproctitle('php:XInotifySync Main process');
<a name="line69"></a>        $pid = pcntl_fork();
<a name="line70"></a>        if($pid == -1) throw new XException('fork inotify process failure');
<a name="line71"></a>        if($pid == 0) {
<a name="line72"></a>            setproctitle('php:XInotifySync Watcher');
<a name="line73"></a>            $this->logs('Watcher Starter');
<a name="line74"></a>            $this->inotify_sock = $ips[0];
<a name="line75"></a>            fclose($ips[1]);
<a name="line76"></a>            $this->create_inotify_instance();
<a name="line77"></a>            $this->watch_list_conf = $watch_list_conf;
<a name="line78"></a>            $this->watch_list_conf_wd = inotify_add_watch($this->inotify_instance,$watch_list_conf,IN_CLOSE_WRITE);
<a name="line79"></a>            $this->add_form_file($this->watch_list_conf);
<a name="line80"></a>            $this->watch_loop();
<a name="line81"></a>            $this->logs('Watcher Exit');
<a name="line82"></a>            exit(0);
<a name="line83"></a>        }
<a name="line84"></a>        //fork sync process
<a name="line85"></a>        $pid = pcntl_fork();
<a name="line86"></a>        if($pid == -1) throw new XException('fork sync process failure');
<a name="line87"></a>        if($pid == 0) {
<a name="line88"></a>            $this->logs('Dispatcher start');
<a name="line89"></a>            $this->sync_sock = $ips[1];
<a name="line90"></a>            setproctitle('php:XInotifySync Dispatcher');
<a name="line91"></a>            fclose($ips[0]);
<a name="line92"></a>            $this->sync_master_process_loop();
<a name="line93"></a>            $this->logs('Dispatcher Exit');
<a name="line94"></a>            exit(0);
<a name="line95"></a>        }
<a name="line96"></a>        $i = 0;
<a name="line97"></a>        while(true) {
<a name="line98"></a>           pcntl_wait($status);
<a name="line99"></a>        }
<a name="line100"></a>    }
<a name="line101"></a>    private function err($msg) {
<a name="line102"></a>        $this->msg($msg);
<a name="line103"></a>        exit(1);
<a name="line104"></a>    }
<a name="line105"></a>    private function msg($msg) {
<a name="line106"></a>        $time = microtime(true);
<a name="line107"></a>        $pid = posix_getpid();
<a name="line108"></a>        echo "$time:PID:$pid:$msg\r\n";
<a name="line109"></a>    }
<a name="line110"></a>    private function logs($msg) {
<a name="line111"></a>        list(,$time) = explode(' ', microtime());
<a name="line112"></a>        $pid = posix_getpid();
<a name="line113"></a>        $date = date('Ymd.H:i:s');
<a name="line114"></a>        $str = "{$date}.{$time}:PID:$pid:$msg\r\n";
<a name="line115"></a>        $date = date('Ymd');
<a name="line116"></a>        file_put_contents("{$this->log_file_dir}/log_{$date}",$str,FILE_APPEND);
<a name="line117"></a>    }
<a name="line118"></a>    private function create_inotify_instance() {
<a name="line119"></a>        $this->inotify_instance = inotify_init();
<a name="line120"></a>    }
<a name="line121"></a>    public function watch($path,$ip,$port,$username, $password,$tpath) {
<a name="line122"></a>        $path = trim($path);
<a name="line123"></a>        $path = rtrim($path,'/');
<a name="line124"></a>        $wd = inotify_add_watch($this->inotify_instance,$path,IN_IGNORED|IN_ISDIR|IN_CLOSE_WRITE|IN_CREATE|IN_MOVE|IN_DELETE);
<a name="line125"></a>        $this->watch_descriptor[$wd]['wd'] = $wd;
<a name="line126"></a>        $this->watch_descriptor[$wd]['local_path'] = $path;
<a name="line127"></a>        $this->watch_descriptor[$wd]['target_ip'] = $ip;
<a name="line128"></a>        $this->watch_descriptor[$wd]['target_port'] = $port;
<a name="line129"></a>        $this->watch_descriptor[$wd]['target_path'] = $tpath;
<a name="line130"></a>        $this->watch_descriptor[$wd]['username'] = $username;
<a name="line131"></a>        $this->watch_descriptor[$wd]['password'] = $password;
<a name="line132"></a>        if(is_dir($path)) {
<a name="line133"></a>            $this->add_sub_dir($wd);
<a name="line134"></a>        }
<a name="line135"></a>        return $wd;
<a name="line136"></a>    }
<a name="line137"></a>    public function rm($wd) {
<a name="line138"></a>        try{
<a name="line139"></a>            @inotify_rm_watch($this->inotify_instance, $wd);
<a name="line140"></a>            $parent_path = $this->watch_descriptor[$wd]['local_path'];
<a name="line141"></a>            $path_len = strlen($parent_path) - 1;
<a name="line142"></a>            unset($this->watch_descriptor[$wd]);
<a name="line143"></a>            if(is_dir($this->watch_descriptor[$wd]['local_path'])) {
<a name="line144"></a>                foreach($this->watch_descriptor as $wd => $info) {
<a name="line145"></a>                    if(substr($info['local_path'],0,$path_len) == $parent_path) {
<a name="line146"></a>                        @inotify_rm_watch($this->inotify_instance, $wd);
<a name="line147"></a>                        unset($this->watch_descriptor[$wd]);
<a name="line148"></a>                    }
<a name="line149"></a>                }
<a name="line150"></a>            }
<a name="line151"></a>        }catch(XException $e) {}
<a name="line152"></a>    }
<a name="line153"></a>    public function rm_dir_wd($path) {
<a name="line154"></a>        foreach($this->watch_descriptor as $wd => $info) {
<a name="line155"></a>            if($path == $info['local_path']) {
<a name="line156"></a>                $this->rm($wd); //force remove watch_descriptor even it auto remove
<a name="line157"></a>                unset($this->watch_descriptor[$wd]);
<a name="line158"></a>                break;
<a name="line159"></a>            }
<a name="line160"></a>        }
<a name="line161"></a>    }
<a name="line162"></a>    public function rm_all_watch() {
<a name="line163"></a>        foreach($this->watch_descriptor as $wd => $path) {
<a name="line164"></a>            $this->rm($wd);
<a name="line165"></a>        }
<a name="line166"></a>    }
<a name="line167"></a>    public function queue() {
<a name="line168"></a>        $this->pending_event = inotify_queue_len($this->inotify_instance);
<a name="line169"></a>    }
<a name="line170"></a>    public function get() {
<a name="line171"></a>        return inotify_read($this->inotify_instance);
<a name="line172"></a>    }
<a name="line173"></a>    public function add_form_array($file_list) {
<a name="line174"></a>        if(!is_array($file_list)) return;
<a name="line175"></a>        foreach($file_list as $server ) {
<a name="line176"></a>            $wd = $this->watch($server['local_path'],
<a name="line177"></a>                               $server['target_ip'], 
<a name="line178"></a>                               $server['target_port'],
<a name="line179"></a>                               $server['username'],
<a name="line180"></a>                               $server['password'],
<a name="line181"></a>                               $server['target_path']);
<a name="line182"></a>        }
<a name="line183"></a>    }
<a name="line184"></a>    public function file_transport_process_exit($signo) {
<a name="line185"></a>        pcntl_wait($status);
<a name="line186"></a>    }
<a name="line187"></a>    /**
<a name="line188"></a>     * sync_master_process_loop 
<a name="line189"></a>     * file sync master process
<a name="line190"></a>     * 
<a name="line191"></a>     * @access public
<a name="line192"></a>     * @return void
<a name="line193"></a>     */
<a name="line194"></a>    private function sync_master_process_loop() {
<a name="line195"></a>        while(1) {
<a name="line196"></a>            if(is_resource($this->sync_sock) == false) {
<a name="line197"></a>                $this->err('pip error');
<a name="line198"></a>                return;
<a name="line199"></a>            }
<a name="line200"></a>            pcntl_signal_dispatch();
<a name="line201"></a>            $read = array($this->sync_sock);
<a name="line202"></a>            $write = null;
<a name="line203"></a>            $except = null;
<a name="line204"></a>            $chg_num = stream_select($read,$write,$except,200000);
<a name="line205"></a>            if($chg_num > 0) {
<a name="line206"></a>                usleep(100000);
<a name="line207"></a>                $str = fread($this->sync_sock,10000);
<a name="line208"></a>                $message_group = explode("\r\n",$str);
<a name="line209"></a>                $ph = opendir($this->run_dir);
<a name="line210"></a>                $trans_num = 0;
<a name="line211"></a>                while(false === ($f = readdir($ph))) {
<a name="line212"></a>                    if($f == '.'|| $f == '..') continue;
<a name="line213"></a>                    $trans_num++;
<a name="line214"></a>                }
<a name="line215"></a>                if($trans_num <= $this->max_transporter) {
<a name="line216"></a>                    $file_info = array('U'=> array(),
<a name="line217"></a>                        'D'=>array(),
<a name="line218"></a>                        'MF'=> array(),
<a name="line219"></a>                        'MT'=> array());
<a name="line220"></a>                }
<a name="line221"></a>                foreach($message_group as $mstr) {
<a name="line222"></a>                    $unit = unserialize($mstr);
<a name="line223"></a>                    if(is_array($unit)) {
<a name="line224"></a>                        $this->merge($file_info,$unit);
<a name="line225"></a>                    }
<a name="line226"></a>                }
<a name="line227"></a>                if($trans_num <= $this->max_transporter) {
<a name="line228"></a>                    $tmp_pid = $this->transporter_file($file_info);
<a name="line229"></a>                    pcntl_waitpid($tmp_pid, $status);
<a name="line230"></a>                }
<a name="line231"></a>            }
<a name="line232"></a>        }
<a name="line233"></a>    }
<a name="line234"></a>    private function merge(&$file_info, $unit) {
<a name="line235"></a>        foreach($unit as $t => $value) {
<a name="line236"></a>            if($t == 'MT' || $t == 'MF') {
<a name="line237"></a>                foreach($value as $i => $f) {
<a name="line238"></a>                    $file_info[$t][$i] = $f;
<a name="line239"></a>                }
<a name="line240"></a>            } else {
<a name="line241"></a>                foreach($value as $i => $f) {
<a name="line242"></a>                    $file_info[$t][] = $f;
<a name="line243"></a>                }
<a name="line244"></a>            }
<a name="line245"></a>        }
<a name="line246"></a>    }
<a name="line247"></a>    private function transporter_pid() {
<a name="line248"></a>        $pid = posix_getpid();
<a name="line249"></a>        file_put_contents($this->run_dir.'/'.$pid,$pid);
<a name="line250"></a>    }
<a name="line251"></a>    private function rm_transporter_pid() {
<a name="line252"></a>        $pid = posix_getpid();
<a name="line253"></a>        unlink($this->run_dir.'/'.$pid);
<a name="line254"></a>    }
<a name="line255"></a>    /**
<a name="line256"></a>     * sync_file 
<a name="line257"></a>     * file or directory transport opreate process
<a name="line258"></a>     * 
<a name="line259"></a>     * @param mixed $str 
<a name="line260"></a>     * @access private
<a name="line261"></a>     * @return void
<a name="line262"></a>     */
<a name="line263"></a>    private function transporter_file($change_list) {
<a name="line264"></a>        $fock_pid = pcntl_fork();
<a name="line265"></a>        if($fock_pid == -1) throw new XException('fork #1 Error');
<a name="line266"></a>        if($fock_pid >0) return $fock_pid;
<a name="line267"></a>        $fock_pid = pcntl_fork();
<a name="line268"></a>        if($fock_pid == -1) throw new XException('fork #2 ERROR');
<a name="line269"></a>        if($fock_pid>0) exit(0);
<a name="line270"></a>        chdir('/');
<a name="line271"></a>        umask('0');
<a name="line272"></a>        posix_setsid();
<a name="line273"></a>        fclose(STDIN);
<a name="line274"></a>        fclose(STDOUT);
<a name="line275"></a>        fclose(STDERR);
<a name="line276"></a>        $this->transporter_pid();
<a name="line277"></a>        fclose($this->sync_sock);
<a name="line278"></a>        setproctitle('php:XInotifySync Transporter');
<a name="line279"></a>        $this->logs('new Transporter Start');
<a name="line280"></a>        $sendfile_list = $change_list['U'];
<a name="line281"></a>        $file_num = count($sendfile_list);
<a name="line282"></a>        $move_del = array_diff_key($change_list['MF'],$change_list['MT']);
<a name="line283"></a>        $move_create = array_diff_key($change_list['MT'], $change_list['MF']);
<a name="line284"></a>        if(count($move_create) > 0) {
<a name="line285"></a>            $sendfile_list += $move_create;
<a name="line286"></a>        }
<a name="line287"></a>        $move = array_intersect_key($change_list['MF'],$change_list['MT']);
<a name="line288"></a>        if(count($move) > 0) {
<a name="line289"></a>            $pid = $this->exec_sync_mv($move, $move_to);
<a name="line290"></a>            pcntl_waitpid($pid, $status);
<a name="line291"></a>        }
<a name="line292"></a>        if(count($move_del) > 0) {
<a name="line293"></a>            $change_list['D'] += $move_del;
<a name="line294"></a>        }
<a name="line295"></a>        if(count($change_list['D']) > 0) {
<a name="line296"></a>            $pid = $this->exec_sync_rm($change_list['D']);
<a name="line297"></a>            pcntl_waitpid($pid, $status);
<a name="line298"></a>        }
<a name="line299"></a>        if($file_num >= $this->max_sync_process_num) {
<a name="line300"></a>            $max_num = $this->max_sync_process_num;
<a name="line301"></a>        } else {
<a name="line302"></a>            $max_num = $file_num;
<a name="line303"></a>        }
<a name="line304"></a>        $pnum = 1;
<a name="line305"></a>        $current_sync_queen = array();
<a name="line306"></a>        while(true) {
<a name="line307"></a>            if(count($sendfile_list) == 0) break;
<a name="line308"></a>            $file = array_shift($sendfile_list);
<a name="line309"></a>            $pid = $this->exec_sync_send_file($file);
<a name="line310"></a>            $pnum++;
<a name="line311"></a>            $current_sync_queen[$pid] = $pnum;
<a name="line312"></a>            if($pnum >= $max_num) {
<a name="line313"></a>                while(true) {
<a name="line314"></a>                    if(count($current_sync_queen) == 0) break;
<a name="line315"></a>                    $pid = pcntl_wait($status);
<a name="line316"></a>                    unset($current_sync_queen[$pid]);
<a name="line317"></a>                }
<a name="line318"></a>            }
<a name="line319"></a>        }
<a name="line320"></a>        $this->logs('transporter exit');
<a name="line321"></a>        $this->rm_transporter_pid();
<a name="line322"></a>        exit(0);
<a name="line323"></a>    }
<a name="line324"></a>
<a name="line325"></a>    /**
<a name="line326"></a>     * exec_sync_send_file 
<a name="line327"></a>     * create a file or directory sysnc of instance
<a name="line328"></a>     * 
<a name="line329"></a>     * @param mixed $watch_info 
<a name="line330"></a>     * @access private
<a name="line331"></a>     * @return void
<a name="line332"></a>     */
<a name="line333"></a>    private function exec_sync_send_file($watch_info) {
<a name="line334"></a>        $pid = pcntl_fork();
<a name="line335"></a>        if($pid > 0) return $pid;
<a name="line336"></a>        if($pid == -1) {
<a name="line337"></a>            $this->logs('fork file send process error');
<a name="line338"></a>            return;
<a name="line339"></a>        }
<a name="line340"></a>        setproctitle('php:XInotifySync Execer');
<a name="line341"></a>        $this->logs("send file {$watch_info['local_path']} to {$watch_info['target_path']}");
<a name="line342"></a>        $ssh_ins = new XSSH2($watch_info['target_ip'],$watch_info['target_port'],
<a name="line343"></a>                            $watch_info['username'], $watch_info['password']);
<a name="line344"></a>        $ssh_ins->connect();
<a name="line345"></a>        $ssh_ins->create_sftp();
<a name="line346"></a>        if(is_dir($watch_info['local_path'])) {
<a name="line347"></a>            $ssh_ins->mkdir($watch_info['target_path'],0644);
<a name="line348"></a>            $this->send_all_sub_file($ssh_ins, $watch_info['local_path'],
<a name="line349"></a>                                        $watch_info['target_path'],0644);
<a name="line350"></a>        } else {
<a name="line351"></a>            $ssh_ins->sendfile($watch_info['local_path'],$watch_info['target_path'],0644);
<a name="line352"></a>        }
<a name="line353"></a>        exit(0);
<a name="line354"></a>    }
<a name="line355"></a>
<a name="line356"></a>    /**
<a name="line357"></a>     * send_all_sub_file 
<a name="line358"></a>     * send files and directories inside the local path 
<a name="line359"></a>     * 
<a name="line360"></a>     * @param mixed $ssh_ins 
<a name="line361"></a>     * @param mixed $local_path 
<a name="line362"></a>     * @param mixed $target_path 
<a name="line363"></a>     * @access private
<a name="line364"></a>     * @return void
<a name="line365"></a>     */
<a name="line366"></a>    private function send_all_sub_file($ssh_ins, $local_path, $target_path) {
<a name="line367"></a>        $dh = opendir($local_path);
<a name="line368"></a>        while(false !== ($f = readdir($dh))) {
<a name="line369"></a>            if($f == '.' || $f == '..') continue;
<a name="line370"></a>            $local_file = "{$local_path}/{$f}";
<a name="line371"></a>            $remote_file = "{$target_path}/{$f}";
<a name="line372"></a>            if(is_dir($local_file)) {
<a name="line373"></a>                $ssh_ins->mkdir($remote_file);
<a name="line374"></a>                $this->send_all_sub_file($ssh_ins,$local_file, $remote_file);
<a name="line375"></a>            } else {
<a name="line376"></a>                $ssh_ins->sendfile($local_file,$remote_file, 0644);
<a name="line377"></a>            }
<a name="line378"></a>        }
<a name="line379"></a>    }
<a name="line380"></a>    private function exec_sync_mv($move_form, $move_to) {
<a name="line381"></a>        $pid = pcntl_fork();
<a name="line382"></a>        if($pid > 0) return $pid;
<a name="line383"></a>        if($pid == -1) {
<a name="line384"></a>            $this->logs('fork move file process error');
<a name="line385"></a>            return;
<a name="line386"></a>        }
<a name="line387"></a>        setproctitle('php:XInotifySync Mover');
<a name="line388"></a>        $ssh_conn_list = array();
<a name="line389"></a>        foreach($move_form as $cookie => $file) {
<a name="line390"></a>            if(!in_array($file['target_ip'],$ssh_conn_list)) {
<a name="line391"></a>                $ssh_ins = new XSSH2($file['target_ip'],$file['target_port'],
<a name="line392"></a>                                $file['username'],$file['password']);
<a name="line393"></a>                $ssh_conn_list[$file['target_ip']] = $ssh_ins;
<a name="line394"></a>                $ssh_ins->connect();
<a name="line395"></a>                $ssh_ins->create_sftp();
<a name="line396"></a>            } else {
<a name="line397"></a>                $ssh_ins = $ssh_conn_list[$file['target_ip']];
<a name="line398"></a>            }
<a name="line399"></a>            $this->logs("mv {$file['target_path']} to {$move_to[$cookie]['target_path']}");
<a name="line400"></a>            $ssh_ins->mv($file['target_path'], $move_to[$cookie]['target_path']);
<a name="line401"></a>        }
<a name="line402"></a>        foreach($ssh_conn_list as $ssh_ins) {
<a name="line403"></a>            $ssh_ins->disconnect();
<a name="line404"></a>        }
<a name="line405"></a>        exit(0);
<a name="line406"></a>    }
<a name="line407"></a>    private function exec_sync_rm($delete) {
<a name="line408"></a>        $pid = pcntl_fork();
<a name="line409"></a>        if($pid >0) return $pid;
<a name="line410"></a>        if($pid == -1) {
<a name="line411"></a>            $this->logs('fork del file process error');
<a name="line412"></a>            return;
<a name="line413"></a>        }
<a name="line414"></a>        setproctitle('php:XInotifySync Deleter');
<a name="line415"></a>        $ssh_conn_list = array();
<a name="line416"></a>        foreach($delete as $file) {
<a name="line417"></a>            if(!in_array($file['target_ip'],$ssh_conn_list)) {
<a name="line418"></a>                $ssh_ins = new XSSH2($file['target_ip'],$file['target_port'],
<a name="line419"></a>                                $file['username'],$file['password']);
<a name="line420"></a>                $ssh_ins->connect();
<a name="line421"></a>                $ssh_ins->create_sftp();
<a name="line422"></a>            } else {
<a name="line423"></a>                $ssh_ins = $ssh_conn_list[$file['target_ip']];
<a name="line424"></a>            }
<a name="line425"></a>            $this->logs("rm file {$file['target_path']}");
<a name="line426"></a>            $ssh_ins->rm($file['target_path']);
<a name="line427"></a>        }
<a name="line428"></a>        foreach($ssh_conn_list as $ssh_ins) {
<a name="line429"></a>            $ssh_ins->disconnect();
<a name="line430"></a>        }
<a name="line431"></a>        exit(0);
<a name="line432"></a>    }
<a name="line433"></a>    /**
<a name="line434"></a>     * notify_file_list 
<a name="line435"></a>     * send the change list info to sysnc process
<a name="line436"></a>     * 
<a name="line437"></a>     * @param mixed $watch_info 
<a name="line438"></a>     * @param mixed $change 
<a name="line439"></a>     * @access public
<a name="line440"></a>     * @return void
<a name="line441"></a>     */
<a name="line442"></a>    private function notify_file_list($change) {
<a name="line443"></a>        $change_str = serialize($change) . "\r\n";
<a name="line444"></a>        $read = null;
<a name="line445"></a>        $write = array($this->inotify_sock);
<a name="line446"></a>        $except = null;
<a name="line447"></a>        $chg_num = 0;
<a name="line448"></a>        $chg_num = stream_select($read,$write,$except,200000);
<a name="line449"></a>        if($chg_num > 0) {
<a name="line450"></a>            if(in_array($this->inotify_sock,$write)) {
<a name="line451"></a>                $len = fwrite($this->inotify_sock,$change_str, strlen($change_str));
<a name="line452"></a>                $write = array();
<a name="line453"></a>            }
<a name="line454"></a>        }
<a name="line455"></a>    }
<a name="line456"></a>    public function add_form_file($file) {
<a name="line457"></a>        $ini = XConfig::parse_ini($file);
<a name="line458"></a>        $this->add_form_array($ini);
<a name="line459"></a>    }
<a name="line460"></a>    private function add_sub_dir($wd) {
<a name="line461"></a>        $watch_descriptor = $this->watch_descriptor[$wd];
<a name="line462"></a>        $dh = opendir($watch_descriptor['local_path']);
<a name="line463"></a>        if($dh === false) return;
<a name="line464"></a>        while(false !== ($name = readdir($dh))) {
<a name="line465"></a>            if($name == '.' || $name == '..') continue;
<a name="line466"></a>            $path_dir = "{$watch_descriptor['local_path']}/{$name}";
<a name="line467"></a>            $tpath = "{$watch_descriptor['target_path']}/{$name}";
<a name="line468"></a>            if(is_dir($path_dir)) {
<a name="line469"></a>                $nwd = $this->watch($path_dir, $watch_descriptor['target_ip'],
<a name="line470"></a>                             $watch_descriptor['target_port'], 
<a name="line471"></a>                            $watch_descriptor['username'],
<a name="line472"></a>                            $watch_descriptor['password'],
<a name="line473"></a>                             $tpath);
<a name="line474"></a>                $this->add_sub_dir($nwd);
<a name="line475"></a>            }
<a name="line476"></a>        }
<a name="line477"></a>
<a name="line478"></a>    }
<a name="line479"></a>    public function reload_watch_list($ev_info) {
<a name="line480"></a>        $this->rm_all_watch();
<a name="line481"></a>        if($ev_info['mask'] & IN_DELETE_SELF ||
<a name="line482"></a>                $ev_info['mask'] & IN_MOVE_SELF) {
<a name="line483"></a>            return;
<a name="line484"></a>        }
<a name="line485"></a>        $this->add_form_file($this->watch_list_conf);
<a name="line486"></a>    }
<a name="line487"></a>    private function watch_loop() {
<a name="line488"></a>        $proto_array = array(
<a name="line489"></a>                'D' => array(),
<a name="line490"></a>                'MT' => array(),
<a name="line491"></a>                'MF' => array(),
<a name="line492"></a>                'U' => array());
<a name="line493"></a>        $event_counter = 0;
<a name="line494"></a>        stream_set_blocking($this->inotify_instance,1);
<a name="line495"></a>        while(true) {
<a name="line496"></a>            $move_status = 0;
<a name="line497"></a>            $events = $this->get();
<a name="line498"></a>            if($event_counter === 0) {
<a name="line499"></a>                $event_counter = 1;
<a name="line500"></a>                $first_timestamp = microtime(true);
<a name="line501"></a>            } else if($event_counter === 1) {
<a name="line502"></a>                $event_counter = 2;
<a name="line503"></a>                $second_timestamp = microtime(true);
<a name="line504"></a>                $frep_time = (float)$second_timestamp - (float)$first_timestamp;
<a name="line505"></a>                if($frep_time > 0.11) {
<a name="line506"></a>                    $event_counter = $second_timestamp = $first_timestamp = 0;
<a name="line507"></a>                } else if($frep_time >= 0.099 && $frep_time <= 0.11) {
<a name="line508"></a>                    usleep(30000);
<a name="line509"></a>                    $event_counter = $second_timestamp = $first_timestamp = 0;
<a name="line510"></a>                }
<a name="line511"></a>            } else if($event_counter === 2) {
<a name="line512"></a>                $event_counter = 0;
<a name="line513"></a>                $thrid_timestamp = microtime(true);
<a name="line514"></a>                $frep_time = (float)$thrid_timestamp - (float)$second_timestamp;
<a name="line515"></a>                if($frep_time <= 0.09) {
<a name="line516"></a>                    usleep(50000);
<a name="line517"></a>                }
<a name="line518"></a>                $second_timestamp = $first_timestamp = 0;
<a name="line519"></a>            }
<a name="line520"></a>            $this->logs('New events');
<a name="line521"></a>            $change = $proto_array; 
<a name="line522"></a>            foreach($events as $ev => $ev_info) {
<a name="line523"></a>                if(!isset($this->watch_descriptor[$ev_info['wd']])) {
<a name="line524"></a>                    continue;
<a name="line525"></a>                }
<a name="line526"></a>                $watch_info = $this->watch_descriptor[$ev_info['wd']];
<a name="line527"></a>                $os_path = "{$watch_info['local_path']}/{$ev_info['name']}";
<a name="line528"></a>                $os_tpath = "{$watch_info['target_path']}/{$ev_info['name']}";
<a name="line529"></a>                $wd = $ev_info['wd'];
<a name="line530"></a>                if($ev_info['wd'] == $this->watch_list_conf_wd) {
<a name="line531"></a>                    $this->reload_watch_list($ev_info);
<a name="line532"></a>                    continue;
<a name="line533"></a>                }
<a name="line534"></a>                switch($ev_info['mask']) {
<a name="line535"></a>                    case IN_CREATE|IN_ISDIR: //创建文件夹
<a name="line536"></a>                        $wd = $this->watch($os_path, $watch_info['target_ip'],
<a name="line537"></a>                                            $watch_info['target_port'],
<a name="line538"></a>                                            $watch_info['username'],
<a name="line539"></a>                                            $watch_info['password'],
<a name="line540"></a>                                            $os_tpath);
<a name="line541"></a>                        $chain = 'U';
<a name="line542"></a>                        $nid = $wd;
<a name="line543"></a>                    break;
<a name="line544"></a>                    case IN_CREATE:
<a name="line545"></a>                        $chain = null;
<a name="line546"></a>                    break;
<a name="line547"></a>                    case IN_CLOSE_WRITE:  //修改
<a name="line548"></a>                        $chain = 'U';
<a name="line549"></a>                        $nid = $wd;
<a name="line550"></a>                        $this->msg('write');
<a name="line551"></a>                    break;
<a name="line552"></a>                    case IN_MOVED_TO:
<a name="line553"></a>                        $chain = 'U';
<a name="line554"></a>                        $nid = $wd;
<a name="line555"></a>                    break;
<a name="line556"></a>                    case IN_MOVED_TO|IN_ISDIR: //移进
<a name="line557"></a>                        $wd = $this->watch($os_path, $watch_info['target_ip'],
<a name="line558"></a>                                            $watch_info['target_port'],
<a name="line559"></a>                                            $watch_info['username'],
<a name="line560"></a>                                            $watch_info['password'],
<a name="line561"></a>                                            $os_tpath);
<a name="line562"></a>                        $nid = $ev_info['cookie'];
<a name="line563"></a>                        $chain = 'MT';
<a name="line564"></a>                    break;
<a name="line565"></a>                    case IN_MOVED_FROM|IN_ISDIR: //移除文件夹
<a name="line566"></a>                        $this->rm_dir_wd($os_path, true);
<a name="line567"></a>                        $nid = $ev_info['cookie'];
<a name="line568"></a>                        $chain = 'MF';
<a name="line569"></a>                    break;
<a name="line570"></a>                    case IN_MOVED_FROM: //移除文件
<a name="line571"></a>                        $nid = $wd;
<a name="line572"></a>                        $chain = 'D';
<a name="line573"></a>                    break;
<a name="line574"></a>                    case IN_DELETE:
<a name="line575"></a>                        $nid = $wd;
<a name="line576"></a>                        $chain = 'D';
<a name="line577"></a>                    break;
<a name="line578"></a>                    case IN_DELETE|IN_ISDIR:  //删除
<a name="line579"></a>                        $nid = $wd;
<a name="line580"></a>                        $chain = 'D';
<a name="line581"></a>                        $this->rm_dir_wd($os_path);
<a name="line582"></a>                    break;
<a name="line583"></a>                    case IN_DELETE_SELF:  //监视文件夹删除
<a name="line584"></a>                        $thsi->rm($ev_info['wd']);
<a name="line585"></a>                    break;
<a name="line586"></a>                    case IN_MOVE_SELF: //监视文件夹移动
<a name="line587"></a>                    break;
<a name="line588"></a>                    default:
<a name="line589"></a>                    break;
<a name="line590"></a>                }
<a name="line591"></a>                if($chain == null) continue;
<a name="line592"></a>                $array = array();
<a name="line593"></a>                $array['local_path'] = $os_path;
<a name="line594"></a>                $array['target_path'] = $os_tpath;
<a name="line595"></a>                $array['target_ip'] = $watch_info['target_ip'];
<a name="line596"></a>                $array['target_port'] = $watch_info['target_port'];
<a name="line597"></a>                $array['username'] = $watch_info['username'];
<a name="line598"></a>                $array['password'] = $watch_info['password'];
<a name="line599"></a>                $change[$chain][$nid] = $array;
<a name="line600"></a>            }
<a name="line601"></a>            if($change != $proto_array) {
<a name="line602"></a>                $this->notify_file_list($change);
<a name="line603"></a>            }
<a name="line604"></a>        }
<a name="line605"></a>    }
<a name="line606"></a>    public function __destruct() {
<a name="line607"></a>        if(is_resource($this->inotify_instance)) {
<a name="line608"></a>            fclose($this->inotify_instance);
<a name="line609"></a>        }
<a name="line610"></a>    }
<a name="line611"></a>}
<a name="line612"></a></pre>
<div class="header">
<h1>ToKnot</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../todo-list.html">Todo</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source/xinotifysync.php.html" target="_top">No frames</a>
</div>
<hr>

<p id="footer">This document was generated by <a href="http://peej.github.com/phpdoctor/">PHPDoctor: The PHP Documentation Creator</a></p>

</body>

</html>