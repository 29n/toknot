<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="generator" content="PHPDoctor 2RC4 (http://peej.github.com/phpdoctor/)">
<meta name="when" content="Tue, 28 Aug 2012 09:17:47 +0000">

<link rel="stylesheet" type="text/css" href="../stylesheet.css">
<link rel="start" href="../overview-summary.html">

<title>XScheduler.php (PHPDoctor)</title>

</head>
<body id="file" onload="parent.document.title=document.title;">

<div class="header">
<h1>PHPDoctor</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../todo-list.html">Todo</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source/xscheduler.php.html" target="_top">No frames</a>
</div>
<hr>

<h1>XScheduler.php</h1>
<div class="comment" id="overview_description"><p>Toknot</p><p>XScheduler class</p><p>PHP version 5.3</p></div>

<hr>

<a name="line1"></a><pre><?php
<a name="line2"></a>/**
<a name="line3"></a> * Toknot
<a name="line4"></a> *
<a name="line5"></a> * XScheduler class
<a name="line6"></a> *
<a name="line7"></a> * PHP version 5.3
<a name="line8"></a> * 
<a name="line9"></a> * @author chopins xiao <chopins.xiao@gmail.com>
<a name="line10"></a> * @copyright  2012 The Authors
<a name="line11"></a> * @license    http://opensource.org/licenses/bsd-license.php New BSD License
<a name="line12"></a> * @link       http://blog.toknot.com
<a name="line13"></a> * @since      File available since Release 0.6
<a name="line14"></a> */
<a name="line15"></a>exists_frame();
<a name="line16"></a>
<a name="line17"></a>/**
<a name="line18"></a> * XScheduler 
<a name="line19"></a> * 
<a name="line20"></a> * @uses XObject
<a name="line21"></a> * @final
<a name="line22"></a> * @version $id$
<a name="line23"></a> * @copyright 2012 The Author
<a name="line24"></a> * @author Chopins xiao <chopins.xiao@gmail.com> 
<a name="line25"></a> * @license http://opensource.org/licenses/bsd-license.php New BSD License
<a name="line26"></a> */
<a name="line27"></a>
<a name="line28"></a>final class XScheduler extends XObject {
<a name="line29"></a>    /**
<a name="line30"></a>     * app_instance 
<a name="line31"></a>     * 
<a name="line32"></a>     * @var object
<a name="line33"></a>     * @access public
<a name="line34"></a>     */
<a name="line35"></a>    public $app_instance;
<a name="line36"></a>    /**
<a name="line37"></a>     * app_method 
<a name="line38"></a>     * 
<a name="line39"></a>     * @var mixed
<a name="line40"></a>     * @access private
<a name="line41"></a>     */
<a name="line42"></a>    private $app_method;
<a name="line43"></a>    /**
<a name="line44"></a>     * exception_string 
<a name="line45"></a>     * 
<a name="line46"></a>     * @var string
<a name="line47"></a>     * @access private
<a name="line48"></a>     */
<a name="line49"></a>    private $exception_string = '';
<a name="line50"></a>    /**
<a name="line51"></a>     * server 
<a name="line52"></a>     * 
<a name="line53"></a>     * @var mixed
<a name="line54"></a>     * @access private
<a name="line55"></a>     */
<a name="line56"></a>    private $server = null;
<a name="line57"></a>    /**
<a name="line58"></a>     * utf8 
<a name="line59"></a>     * 
<a name="line60"></a>     * @var string
<a name="line61"></a>     * @access private
<a name="line62"></a>     */
<a name="line63"></a>    private $utf8 = 'utf8';
<a name="line64"></a>    /**
<a name="line65"></a>     * encodeing 
<a name="line66"></a>     * 
<a name="line67"></a>     * @var string
<a name="line68"></a>     * @access public
<a name="line69"></a>     */
<a name="line70"></a>    public $encodeing = '';
<a name="line71"></a>    /**
<a name="line72"></a>     * timezone 
<a name="line73"></a>     * 
<a name="line74"></a>     * @var mixed
<a name="line75"></a>     * @access public
<a name="line76"></a>     */
<a name="line77"></a>    public $timezone;
<a name="line78"></a>    /**
<a name="line79"></a>     * php_dir_name 
<a name="line80"></a>     * 
<a name="line81"></a>     * @var mixed
<a name="line82"></a>     * @access public
<a name="line83"></a>     */
<a name="line84"></a>    public $php_dir_name;
<a name="line85"></a>    /**
<a name="line86"></a>     * url_file_suffix 
<a name="line87"></a>     * 
<a name="line88"></a>     * @var mixed
<a name="line89"></a>     * @access public
<a name="line90"></a>     */
<a name="line91"></a>    public $url_file_suffix;
<a name="line92"></a>    /**
<a name="line93"></a>     * url_list_file 
<a name="line94"></a>     * 
<a name="line95"></a>     * @var mixed
<a name="line96"></a>     * @access public
<a name="line97"></a>     */
<a name="line98"></a>    public $url_list_file;
<a name="line99"></a>    /**
<a name="line100"></a>     * singleton 
<a name="line101"></a>     * 
<a name="line102"></a>     * @static
<a name="line103"></a>     * @access public
<a name="line104"></a>     * @return void
<a name="line105"></a>     */
<a name="line106"></a>    public static function singleton() {
<a name="line107"></a>        return parent::__singleton();
<a name="line108"></a>    }
<a name="line109"></a>    /**
<a name="line110"></a>     * get_ini 
<a name="line111"></a>     * 
<a name="line112"></a>     * @access protected
<a name="line113"></a>     * @return void
<a name="line114"></a>     */
<a name="line115"></a>    protected function get_ini() {
<a name="line116"></a>        $CFG = XConfig::CFG();
<a name="line117"></a>        $this->encoding = $CFG->app->encoding;
<a name="line118"></a>        $this->php_dir_name = $CFG->php_dir_name;
<a name="line119"></a>        $this->timezone = $CFG->app->timezone;
<a name="line120"></a>        $this->url_file_suffix = $CFG->app->url_file_suffix;
<a name="line121"></a>        $this->url_mode = $CFG->app->url_mode;
<a name="line122"></a>        $this->web_index = $CFG->web->index;
<a name="line123"></a>        $this->subsite_mode = $CFG->app->subsite_mode;
<a name="line124"></a>        $this->subsite_start_level = $CFG->app->subsite_start_level;
<a name="line125"></a>        $this->log_dir = $CFG->app->log_dir;
<a name="line126"></a>        $this->ui_dir_name = $CFG->ui_dir_name;
<a name="line127"></a>        $this->url_list_file = $CFG->app->url_list_file;
<a name="line128"></a>    }
<a name="line129"></a>    /**
<a name="line130"></a>     * __construct 
<a name="line131"></a>     * 
<a name="line132"></a>     * @access protected
<a name="line133"></a>     * @return void
<a name="line134"></a>     */
<a name="line135"></a>    protected function __construct() {
<a name="line136"></a>        if(version_compare(PHP_VERSION,'5.3.0') < 0) {
<a name="line137"></a>            throw new XException('only be run on php of varsion  5.3.0 or lastest, current php of version'.PHP_VERSION);
<a name="line138"></a>        }
<a name="line139"></a>
<a name="line140"></a>        define('PHP_CLI',PHP_SAPI =='cli');
<a name="line141"></a>
<a name="line142"></a>        if(PHP_CLI == false) define('__X_WEB_ROOT__',dirname($_SERVER['SCRIPT_FILENAME']));
<a name="line143"></a>        defined('__X_APP_ROOT__') || define('__X_APP_ROOT__',__X_WEB_ROOT__);
<a name="line144"></a>
<a name="line145"></a>        $_ENV['__X_OUT_BROWSER__']     = false;
<a name="line146"></a>        $_ENV['__X_EXCEPTION_THROW__'] = false;
<a name="line147"></a>        $_ENV['__X_FATAL_EXCEPTION__'] = false;
<a name="line148"></a>
<a name="line149"></a>        $this->get_ini();
<a name="line150"></a>
<a name="line151"></a>        $_ENV['__X_CALL_PAGE_DIR__']   = __X_APP_ROOT__. "/{$this->php_dir_name}";
<a name="line152"></a>        $this->check_superglobals();
<a name="line153"></a>        $this->set_time_zone();
<a name="line154"></a>        if(PHP_CLI && __X_NO_WEB_SERVER__ === false) {
<a name="line155"></a>            //fclose(STDERR);
<a name="line156"></a>            return new XWebServer($this);
<a name="line157"></a>        } else if(PHP_CLI && array_search('-d',$_SERVER['argv']) !== false) {
<a name="line158"></a>            return $this->call_loop();
<a name="line159"></a>        } else if(!PHP_CLI){
<a name="line160"></a>            ini_get('register_globals') and new XException('Need close php register_globals in php.ini');
<a name="line161"></a>            $this->load_app();
<a name="line162"></a>            echo $this->get_html();
<a name="line163"></a>        } elseif(PHP_CLI && __X_NO_WEB_SERVER__ && __X_DAEMON_LOOP_FILE__) {
<a name="line164"></a>            return $this->call_loop(false);
<a name="line165"></a>        } else {
<a name="line166"></a>            throw new XException('Run error');
<a name="line167"></a>        }
<a name="line168"></a>    }
<a name="line169"></a>
<a name="line170"></a>    /**
<a name="line171"></a>     * call_loop 
<a name="line172"></a>     * 
<a name="line173"></a>     * @param boolean $_daemon 
<a name="line174"></a>     * @access private
<a name="line175"></a>     * @return void
<a name="line176"></a>     */
<a name="line177"></a>    private function call_loop($_daemon = true) {
<a name="line178"></a>        $loop_file = rtrim(__X_DAEMON_LOOP_FILE__,'/');
<a name="line179"></a>        $_ENV['__X_CALL_PAGE_FILE__'] = __X_APP_ROOT__."/{$this->php_dir_name}".'/'.__X_DAEMON_LOOP_FILE__;
<a name="line180"></a>        if(!file_exists($_ENV['__X_CALL_PAGE_FILE__'])) {
<a name="line181"></a>            throw new XException("File {$_ENV['__X_CALL_PAGE_FILE__']} not be found");
<a name="line182"></a>        }
<a name="line183"></a>        if($_daemon) {
<a name="line184"></a>            daemon();
<a name="line185"></a>        }
<a name="line186"></a>        include_once($_ENV['__X_CALL_PAGE_FILE__']);
<a name="line187"></a>        if($_daemon) {
<a name="line188"></a>            exit(0);
<a name="line189"></a>        }
<a name="line190"></a>    }
<a name="line191"></a>    /**
<a name="line192"></a>     * Load user application view class
<a name="line193"></a>     * 
<a name="line194"></a>     * @access public
<a name="line195"></a>     * @return void
<a name="line196"></a>     */
<a name="line197"></a>    public function load_app() {
<a name="line198"></a>        $this->exception_string = null;
<a name="line199"></a>        $this->init_env_var();
<a name="line200"></a>        try {
<a name="line201"></a>            $this->load_application_class_file();
<a name="line202"></a>        } catch(XException $e) {
<a name="line203"></a>            $this->exception_string = $e->getXDebugTraceAsString();
<a name="line204"></a>            gc_collect_cycles();
<a name="line205"></a>            return;
<a name="line206"></a>        }
<a name="line207"></a>    }
<a name="line208"></a>    /**
<a name="line209"></a>     * check php superglobals whether be set or 
<a name="line210"></a>     * not will set $_SERVER,$_GET,$_COOKIE,$_POST,$_FILES
<a name="line211"></a>     * 
<a name="line212"></a>     * @access private
<a name="line213"></a>     * @return void
<a name="line214"></a>     */
<a name="line215"></a>    private function check_superglobals() {
<a name="line216"></a>        $variables_order = strtoupper(ini_get('variables_order'));
<a name="line217"></a>        if(PHP_CLI == false && strpos($variables_order,'P') === false) {
<a name="line218"></a>            $this->import_post();
<a name="line219"></a>        } else if(strpos($variables_order,'P') === true && $this->utf8 != $this->encoding) {
<a name="line220"></a>            $_POST = unserialize(mb_convert_encoding(serialize($_POST), $this->utf8, $this->encoding));
<a name="line221"></a>        }
<a name="line222"></a>        if(strpos($variables_order,'S') === false) {
<a name="line223"></a>            $_SERVER['_'] = getenv('_');
<a name="line224"></a>            if(PHP_CLI == false) {
<a name="line225"></a>                $_SERVER['REQUEST_URI']     = getenv('REQUEST_URI');
<a name="line226"></a>                $_SERVER['SCRIPT_FILENAME'] = getenv('SCRIPT_FILENAME');
<a name="line227"></a>                $_SERVER['DOCUMENT_URI']    = getenv('DOCUMENT_URI');
<a name="line228"></a>                $_SERVER['REQUEST_METHOD']  = getenv('REQUEST_METHOD');
<a name="line229"></a>                $_SERVER['PATH_INFO']       = getenv('PATH_INFO');
<a name="line230"></a>                $_SERVER['SERVER_ADDR']     = getenv('SERVER_ADDR');
<a name="line231"></a>                $_SERVER['HTTP_HOST']       = getenv('HTTP_HOST');
<a name="line232"></a>                $_SERVER['SERVER_NAME']     = getenv('SERVER_NAME');
<a name="line233"></a>                $_SERVER['QUERY_STRING']    = getenv('QUERY_STRING');
<a name="line234"></a>            }
<a name="line235"></a>        }
<a name="line236"></a>        if(PHP_CLI == false && strpos($variables_order,'G') === false) {
<a name="line237"></a>            if($this->encoding != $this->utf8) {
<a name="line238"></a>                $_SERVER['QUERY_STRING'] = mb_convert_encoding($_SERVER['QUERY_STRING'], $this->utf8,$this->encoding);
<a name="line239"></a>            }
<a name="line240"></a>            parse_str($_SERVER['QUERY_STRING'],$_GET);
<a name="line241"></a>        } else if(strpos($variables_order,'G') === true && $this->utf8 != $this->encoding) {
<a name="line242"></a>            $_GET = unserialize(mb_convert_encoding(serialize($_GET), $this->utf8, $this->encoding));
<a name="line243"></a>        }
<a name="line244"></a>
<a name="line245"></a>        if(PHP_CLI == false && strpos($variables_order,'C') === false) {
<a name="line246"></a>            if($this->encoding != $this->utf8) {
<a name="line247"></a>                $_SERVER['HTTP_COOKIE'] = empty($_SERVER['HTTP_COOKIE']) ? getenv('HTTP_COOKIE') : $_SERVER['HTTP_COOKIE'];
<a name="line248"></a>                $_SERVER['HTTP_COOKIE'] = mb_convert_encoding($_SERVER['HTTP_COOKIE'], $this->utf8, $this->encoding);
<a name="line249"></a>            }
<a name="line250"></a>            get_cookie();
<a name="line251"></a>        } else if(strpos($variables_order,'C') === true && $this->utf8 != $this->encoding) {
<a name="line252"></a>            $_COOKIE = unserialize(mb_convert_encoding(serialize($_COOKIE), $this->utf8, $this->encoding));
<a name="line253"></a>        }
<a name="line254"></a>
<a name="line255"></a>
<a name="line256"></a>    }
<a name="line257"></a>    /**
<a name="line258"></a>     * set $_POST adn $_FILES superglobals
<a name="line259"></a>     * 
<a name="line260"></a>     * @access private
<a name="line261"></a>     * @return void
<a name="line262"></a>     */
<a name="line263"></a>    private function import_post() {
<a name="line264"></a>        $http_body = file_get_contents('php://input','r');
<a name="line265"></a>        if(!empty($http_body)) {
<a name="line266"></a>            $content_type = getenv('HTTP_CONTENT_TYPE');
<a name="line267"></a>            if($content_type == 'application/x-www-form-urlencoded') {
<a name="line268"></a>                if($this->encoding != $this->utf8) 
<a name="line269"></a>                    $http_body = mb_convert_encoding($http_body, $this->utf8,$this->encoding);
<a name="line270"></a>                parse_str($http_body,$_POST);
<a name="line271"></a>            } else {
<a name="line272"></a>                $content_len = getenv('HTTP_CONTENT_LENGTH');
<a name="line273"></a>                $c_field = trim(strtok($content_type,';'));
<a name="line274"></a>                $upload_max_filesize = conv_human_byte(ini_get('upload_max_filesize'));
<a name="line275"></a>                while($c_field !== false) {
<a name="line276"></a>                    switch($c_field) {
<a name="line277"></a>                    case 'multipart/form-data':
<a name="line278"></a>                        $c_field = trim(strtok('='));
<a name="line279"></a>                    break;
<a name="line280"></a>                    case 'boundary':
<a name="line281"></a>                        if(($c_field = strtok(';')) === false) {
<a name="line282"></a>                            $boundary = '--'.trim($c_field);
<a name="line283"></a>                        } else {
<a name="line284"></a>                            $lt = explode('=',$content_type);
<a name="line285"></a>                            $boundary = '--'. trim(array_pop($lt));
<a name="line286"></a>                        }
<a name="line287"></a>                        $c_field = strtok(';');
<a name="line288"></a>                    break;
<a name="line289"></a>                    default:
<a name="line290"></a>                        $c_field = strtok('=');
<a name="line291"></a>                    break;
<a name="line292"></a>                    }
<a name="line293"></a>                }
<a name="line294"></a>                if(empty($boundary)) return;
<a name="line295"></a>                $part_arr = explode($boundary,$http_body);
<a name="line296"></a>                $body_end = false;
<a name="line297"></a>                foreach($part_arr as $part) {
<a name="line298"></a>                    if(empty($part)) continue;
<a name="line299"></a>                    if(trim($part) == '--') {
<a name="line300"></a>                        $body_end = true;
<a name="line301"></a>                        break;
<a name="line302"></a>                    }
<a name="line303"></a>                    $content_arr = explode("\r\n\r\n",$part,2);
<a name="line304"></a>                    $content_data = rtrim($content_arr[1]);
<a name="line305"></a>                    $content_field = trim(strtolower(strtok($content_arr[0],':')));
<a name="line306"></a>                    while(false !== $content_field) {
<a name="line307"></a>                        switch($content_field) {
<a name="line308"></a>                            case 'content-disposition':
<a name="line309"></a>                                $content_field = strtok(';');
<a name="line310"></a>                                $content_field = trim(strtok('='));
<a name="line311"></a>                            break;
<a name="line312"></a>                            case 'name':
<a name="line313"></a>                                $name = strtok('"');
<a name="line314"></a>                                if($name == 'MAX_FILE_SIZE') $form_max_size = $content_data;
<a name="line315"></a>                                $content_field = trim(ltrim(strtok('='),';'));
<a name="line316"></a>                                if($content_field === false) $content_field = trim(strtok(':'));
<a name="line317"></a>                                else $content_field = trim($content_field);
<a name="line318"></a>                            break;
<a name="line319"></a>                            case 'filename':
<a name="line320"></a>                                $filename = strtok('"');
<a name="line321"></a>                                $content_field = strtok(':');
<a name="line322"></a>                                if($content_field === false) $content_field = trim(strtok(':'));
<a name="line323"></a>                                else $content_field = strtolower(trim($content_field));
<a name="line324"></a>                            break;
<a name="line325"></a>                            case 'content-type':
<a name="line326"></a>                                $file_type = trim(strtok("\r\n"));
<a name="line327"></a>                                $content_field = strtok(':');
<a name="line328"></a>                            break;
<a name="line329"></a>                            default:
<a name="line330"></a>                                $content_field = strtok(';');
<a name="line331"></a>                                $content_field = strtok('=');
<a name="line332"></a>                            break;
<a name="line333"></a>                        }
<a name="line334"></a>                    }
<a name="line335"></a>                    if(isset($name) && isset($filename) && $filename !== false) {
<a name="line336"></a>                        $upfile_tmp_dir = isset($this->cfg->server->upfile_tmp_dir) ? 
<a name="line337"></a>                                            $this->cfg->server->upfile_tmp_dir:sys_get_temp_dir();
<a name="line338"></a>                        $tmp = tempnam($upfile_tmp_dir,'tmp_XPF_');
<a name="line339"></a>                        $file_len = strlen($content_data);
<a name="line340"></a>                        if($file_len > $upload_max_filesize) {
<a name="line341"></a>                            $errno = UPLOAD_ERR_INI_SIZE;
<a name="line342"></a>                        } else if($file_len == 0) {
<a name="line343"></a>                            $errno = UPLOAD_ERR_NO_FILE;
<a name="line344"></a>                        } else if(isset($form_max_size) && $form_max_size < $file_len) {
<a name="line345"></a>                            $errno = UPLOAD_ERR_FORM_SIZE;
<a name="line346"></a>                        } else if(empty($upfile_tmp_dir) || !is_dir($upfile_tmp_dir)) {
<a name="line347"></a>                            $errno = UPLOAD_ERR_NO_TMP_DIR;
<a name="line348"></a>                        } else if($body_end == false) {
<a name="line349"></a>                            $errno = UPLOAD_ERR_PARTIAL;
<a name="line350"></a>                        } else {
<a name="line351"></a>                            $errno = UPLOAD_ERR_OK;
<a name="line352"></a>                        }
<a name="line353"></a>                        if($errno == UPLOAD_ERR_OK) {
<a name="line354"></a>                            $fp = file_put_contents($tmp,$content_data);
<a name="line355"></a>                            if($fp === false) $errno = UPLOAD_ERR_CANT_WRITE;
<a name="line356"></a>                        }
<a name="line357"></a>                        if(substr($name,-1,2) == '[]') {
<a name="line358"></a>                            $_FILES[$name]['name'][] = $filename;
<a name="line359"></a>                            $_FILES[$name]['type'][] = $file_type;
<a name="line360"></a>                            $_FILES[$name]['size'][] = $file_len;
<a name="line361"></a>                            $_FILES[$name]['tmp_name'][] = $tmp;
<a name="line362"></a>                            $_FILES[$name]['error'][] = $errno;
<a name="line363"></a>                        } else {
<a name="line364"></a>                            $_FILES[$name]['name'] = $filename;
<a name="line365"></a>                            $_FILES[$name]['type'] = $file_type;
<a name="line366"></a>                            $_FILES[$name]['size'] = $file_len;
<a name="line367"></a>                            $_FILES[$name]['tmp_name'] = $tmp;
<a name="line368"></a>                            $_FILES[$name]['error'] = $errno;
<a name="line369"></a>                        }
<a name="line370"></a>                    } elseif(isset($name)) {
<a name="line371"></a>                        if($this->encoding != $this->utf8) {
<a name="line372"></a>                            $name = mb_convert_encoding($name, $this->utf8,$this->encoding);
<a name="line373"></a>                            $content_data = mb_convert_encoding($content_data, $this->utf8,$this->encoding);
<a name="line374"></a>                        }
<a name="line375"></a>                        if(substr($name,-1,2) == '[]') {
<a name="line376"></a>                            $_POST[$name][] = $content_data;
<a name="line377"></a>                        } else {
<a name="line378"></a>                            $_POST[$name] = $content_data;
<a name="line379"></a>                        } 
<a name="line380"></a>                    }
<a name="line381"></a>                }
<a name="line382"></a>            }
<a name="line383"></a>        }
<a name="line384"></a>    }
<a name="line385"></a>    /**
<a name="line386"></a>     * initialize environment variables of frameworker 
<a name="line387"></a>     * 
<a name="line388"></a>     * @access private
<a name="line389"></a>     * @return void
<a name="line390"></a>     */
<a name="line391"></a>    private function init_env_var() {
<a name="line392"></a>        $uri = strtolower($_SERVER['REQUEST_URI']);
<a name="line393"></a>        if(($pos = strpos($uri,'?')) !== false) {
<a name="line394"></a>            $uri_path     = substr($uri,0,$pos);
<a name="line395"></a>            $query_string = substr($uri,$pos+1);
<a name="line396"></a>        } else {
<a name="line397"></a>            $uri_path     = $uri;
<a name="line398"></a>        }
<a name="line399"></a>        if(empty($uri_path)) $uri_path = '/';
<a name="line400"></a>        $call_page_func = $call_page_name = $prefix_path = '';
<a name="line401"></a>        $url_file_suffix = '.'.$this->url_file_suffix;
<a name="line402"></a>        if($this->url_mode == 1 && isset($query_string)) {
<a name="line403"></a>            $_GET['a']      = empty($_GET['a']) ? '':$_GET['a'];
<a name="line404"></a>            $uri_path       = dirname($_GET['a']);
<a name="line405"></a>            $call_page_func = basename($_GET['a']);
<a name="line406"></a>        } else if($this->url_mode == 2) { //PATH_INFO mode
<a name="line407"></a>            if(empty($_SERVER['PATH_INFO'])) {
<a name="line408"></a>                $_SERVER['PATH_INFO'] = str_replace('/'.basename($_SERVER['SCRIPT_FILENAME']),'',$_SERVER['PHP_SELF']);
<a name="line409"></a>            }
<a name="line410"></a>            $uri_path = dirname($_SERVER['PATH_INFO']);
<a name="line411"></a>            $call_page_func = basename($_SERVER['PATH_INFO']);
<a name="line412"></a>            if(empty($_SERVER['PATH_INFO'])) $call_page_func = basename($_SERVER['DOCUMENT_URI'], $uri_file_suffix);
<a name="line413"></a>        } else if($this->url_mode == 4) {
<a name="line414"></a>            $url_list = XConfig::parse_ini($this->url_list_file);
<a name="line415"></a>            if(isset($url_list[$uri_path])) {
<a name="line416"></a>                list($call_page_name,$call_page_func) = explode('::',$url_list[$uri_path]);
<a name="line417"></a>            } else {
<a name="line418"></a>                not_found();
<a name="line419"></a>            }
<a name="line420"></a>        } else {
<a name="line421"></a>            if($uri_path == '/') {
<a name="line422"></a>                $_SERVER['DOCUMENT_URI'] = strtok($this->web_index,':');
<a name="line423"></a>                $call_page_func = basename($_SERVER['DOCUMENT_URI'],$url_file_suffix);
<a name="line424"></a>                $call_page_name = $call_page_func;
<a name="line425"></a>            } else if(dirname($uri_path) == '/') {
<a name="line426"></a>                $call_page_name = basename($uri_path);
<a name="line427"></a>                $call_page_func = basename(strtok($this->web_index,':'), $url_file_suffix);
<a name="line428"></a>            } else {
<a name="line429"></a>                $call_page_func = basename($uri_path, $url_file_suffix);
<a name="line430"></a>                $call_page_name = basename(dirname($uri_path));
<a name="line431"></a>                $prefix_path    = dirname(dirname($uri_path));
<a name="line432"></a>                if($prefix_path == '/') $prefix_path = '';
<a name="line433"></a>            }
<a name="line434"></a>        }
<a name="line435"></a>        $add_sub_domain_path = '';
<a name="line436"></a>        if($this->subsite_mode > 0) {
<a name="line437"></a>            if($this->subsite_mode < $this->subsite_start_level) {
<a name="line438"></a>                throw new XException('subsite_start_level not be greater than subsite_mode in your confingure file');
<a name="line439"></a>            }
<a name="line440"></a>            if($_SERVER['SERVER_ADDR'] != $_SERVER['HTTP_HOST']) {
<a name="line441"></a>                if(empty($_SERVER['HTTP_HOST'])) {
<a name="line442"></a>                    $_SERVER['HTTP_HOST'] = $_SERVER['SERVER_NAME'];
<a name="line443"></a>                }
<a name="line444"></a>                if(!isip($_SERVER['HTTP_HOST'])) {
<a name="line445"></a>                   $sub_domain_list        = explode('.',$_SERVER['HTTP_HOST']);
<a name="line446"></a>                    $sub_domain_list       = array_reverse($sub_domain_list);
<a name="line447"></a>                    $sub_domain_list_count = count($sub_domain_list) -1;
<a name="line448"></a>                    if($sub_domain_list_count >= $this->subsite_start_level) {
<a name="line449"></a>                        for($i=$this->subsite_start_level;$i<=$this->subsite_mode;$i++) {
<a name="line450"></a>                            $add_sub_domain_path = "{$sub_domain_list[$i]}/{$add_sub_domain_path}";
<a name="line451"></a>                        }
<a name="line452"></a>                    }
<a name="line453"></a>                }
<a name="line454"></a>            }
<a name="line455"></a>        }
<a name="line456"></a>        switch($_SERVER['REQUEST_METHOD']) {
<a name="line457"></a>            case 'GET':
<a name="line458"></a>                $request_method = 'g';
<a name="line459"></a>            break;
<a name="line460"></a>            case 'POST':
<a name="line461"></a>                $request_method = 'p';
<a name="line462"></a>            break;
<a name="line463"></a>            case 'PUT':
<a name="line464"></a>                $request_method = 'u';
<a name="line465"></a>            break;
<a name="line466"></a>            case 'HEAD':
<a name="line467"></a>                $request_method = 'h';
<a name="line468"></a>            break;
<a name="line469"></a>            case 'TRACE':
<a name="line470"></a>                $request_method = 't';
<a name="line471"></a>            break;
<a name="line472"></a>            case 'DELETE':
<a name="line473"></a>                $request_method = 'd';
<a name="line474"></a>            break;
<a name="line475"></a>            default :
<a name="line476"></a>                $request_method = 'o';
<a name="line477"></a>            break;
<a name="line478"></a>        }
<a name="line479"></a>
<a name="line480"></a>        $_ENV['__X_CALL_PAGE_NAME__']    = $call_page_name;
<a name="line481"></a>        $_ENV['__X_CALL_PAGE_FILE__']    = "{$_ENV['__X_CALL_PAGE_DIR__']}{$add_sub_domain_path}{$prefix_path}/{$call_page_name}.php";
<a name="line482"></a>        $_ENV['__X_CALL_PAGE_FUNC__']    = $request_method.ucfirst($call_page_func);
<a name="line483"></a>        $_ENV['__X_APP_UI_DIR__']        = __X_APP_ROOT__.'/'.$this->ui_dir_name;
<a name="line484"></a>        $_ENV['__X_APP_PHP_LOG__'] = __X_APP_DATA_DIR__.'/'.$this->log_dir.'/'.date('Ymd');
<a name="line485"></a>    }
<a name="line486"></a>
<a name="line487"></a>    /**
<a name="line488"></a>     * load view class of user's application
<a name="line489"></a>     * 
<a name="line490"></a>     * @access private
<a name="line491"></a>     * @return void
<a name="line492"></a>     */
<a name="line493"></a>    private function load_application_class_file() {
<a name="line494"></a>        if(!file_exists($_ENV['__X_CALL_PAGE_FILE__'])) {
<a name="line495"></a>            throw new XException("File {$_ENV['__X_CALL_PAGE_FILE__']} not be found");
<a name="line496"></a>        }
<a name="line497"></a>        check_syntax($_ENV['__X_CALL_PAGE_FILE__']);
<a name="line498"></a>        if(!class_exists($_ENV['__X_CALL_PAGE_NAME__'], false)) {
<a name="line499"></a>            include($_ENV['__X_CALL_PAGE_FILE__']);
<a name="line500"></a>        }
<a name="line501"></a>        if(!class_exists($_ENV['__X_CALL_PAGE_NAME__'],false)) {
<a name="line502"></a>            throw new XException("Class {$_ENV['__X_CALL_PAGE_NAME__']} not be found");
<a name="line503"></a>        }
<a name="line504"></a>        $classname = $_ENV['__X_CALL_PAGE_NAME__'];
<a name="line505"></a>        $method = $_ENV['__X_CALL_PAGE_FUNC__'];
<a name="line506"></a>        $ref = new ReflectionClass($_ENV['__X_CALL_PAGE_NAME__']);
<a name="line507"></a>        $request_method = substr($_ENV['__X_CALL_PAGE_FUNC__'],0,1);
<a name="line508"></a>        if($request_method == 'o') {
<a name="line509"></a>            $this->app_instance = $_ENV['__X_CALL_PAGE_NAME__']::singleton();
<a name="line510"></a>            $this->app_instance->get_options($_ENV['__X_CALL_PAGE_NAME__'], $_ENV['__X_CALL_PAGE_FUNC__']);
<a name="line511"></a>            return;
<a name="line512"></a>        }
<a name="line513"></a>        $call_method = $ref->hasMethod($_ENV['__X_CALL_PAGE_FUNC__']);
<a name="line514"></a>        if($call_method === false) {
<a name="line515"></a>            throw new XException("Class {$_ENV['__X_CALL_PAGE_NAME__']} method {$_ENV['__X_CALL_PAGE_FUNC__']} not be found");
<a name="line516"></a>        }
<a name="line517"></a>        $call_method = $ref->getMethod($_ENV['__X_CALL_PAGE_FUNC__']);
<a name="line518"></a>        if($call_method->isDestructor()) {
<a name="line519"></a>            throw new XException('Can not call destruct method');
<a name="line520"></a>        }
<a name="line521"></a>        if($call_method->isPrivate() || $call_method->isProtected()) {
<a name="line522"></a>            throw new XException("Class {$_ENV['__X_CALL_PAGE_NAME__']} method {$_ENV['__X_CALL_PAGE_FUNC__']} is private or protected");
<a name="line523"></a>        }
<a name="line524"></a>        $refX = $ref->getParentClass();
<a name="line525"></a>        if($refX === false || $refX->getName() != 'X') {
<a name="line526"></a>            throw new XException("Class $classname need extends XPHPFramework of class X");
<a name="line527"></a>        }
<a name="line528"></a>        $this->app_instance = $_ENV['__X_CALL_PAGE_NAME__']::singleton();
<a name="line529"></a>        if($call_method->isConstructor() && $this->app_instance->initStat === false) {
<a name="line530"></a>            throw new XException("because class {$_ENV['__X_CALL_PAGE_FUNC__']} defined constructor , so need call to \$this->call_init() within method {$_ENV['__X_CALL_PAGE_FUNC__']} is required in file {$_ENV['__X_CALL_PAGE_FILE__']}");
<a name="line531"></a>        }
<a name="line532"></a>        $this->app_instance->call_init();
<a name="line533"></a>        if($ref->hasMethod('init')) {
<a name="line534"></a>            $this->app_instance->init();
<a name="line535"></a>        }
<a name="line536"></a>        $this->app_instance->run($_ENV['__X_CALL_PAGE_FUNC__']);
<a name="line537"></a>    }
<a name="line538"></a>
<a name="line539"></a>    /**
<a name="line540"></a>     * get html string of view class of user's application
<a name="line541"></a>     * 
<a name="line542"></a>     * @access public
<a name="line543"></a>     * @return void
<a name="line544"></a>     */
<a name="line545"></a>    public function get_html() {
<a name="line546"></a>        if($_ENV['__X_EXCEPTION_THROW__'] && $_ENV['__X_FATAL_EXCEPTION__']) {
<a name="line547"></a>            $html = $this->exception_string;
<a name="line548"></a>        } else {
<a name="line549"></a>            $html = $this->app_instance->get_display_html();
<a name="line550"></a>            $this->app_instance = null;
<a name="line551"></a>            if(PHP_CLI) gc_collect_cycles();
<a name="line552"></a>        }
<a name="line553"></a>        if($this->encoding != $this->utf8) {
<a name="line554"></a>            $html = mb_convert_encoding($html, $this->encoding, $this->utf8);
<a name="line555"></a>        }
<a name="line556"></a>        return $html;
<a name="line557"></a>    }
<a name="line558"></a>    /**
<a name="line559"></a>     * set application timezone of the application
<a name="line560"></a>     * 
<a name="line561"></a>     * @access public
<a name="line562"></a>     * @return void
<a name="line563"></a>     */
<a name="line564"></a>    public function set_time_zone() {
<a name="line565"></a>        if(empty($this->timezone)) {
<a name="line566"></a>            throw new XException('Application timezone unset in config file ');
<a name="line567"></a>        }
<a name="line568"></a>        date_default_timezone_set($this->timezone);
<a name="line569"></a>    }
<a name="line570"></a>}
<a name="line571"></a></pre>
<div class="header">
<h1>PHPDoctor</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../todo-list.html">Todo</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source/xscheduler.php.html" target="_top">No frames</a>
</div>
<hr>

<p id="footer">This document was generated by <a href="http://peej.github.com/phpdoctor/">PHPDoctor: The PHP Documentation Creator</a></p>

</body>

</html>